<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>UTEP SHPE | Student Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: #F3F4F6;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* UTEP Colors */
        .bg-utep-blue { background-color: #041E42; }
        .text-utep-blue { color: #041E42; }
        .bg-utep-orange { background-color: #FF8200; }
        .text-utep-orange { color: #FF8200; }
        
        /* iOS Safe Areas */
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .pt-safe { padding-top: env(safe-area-inset-top); }
        
        /* Scrollbar Hiding & Momentum Scrolling */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { 
            -ms-overflow-style: none; 
            scrollbar-width: none; 
            -webkit-overflow-scrolling: touch;
        }

        /* Glassmorphism */
        .glass {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-top: 1px solid rgba(255,255,255,0.3);
        }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        
        .active-scale:active { transform: scale(0.97); transition: transform 0.1s; }
        
        .card-shadow { box-shadow: 0 10px 30px -10px rgba(4, 30, 66, 0.1); }
        
        .loader { border: 3px solid #E5E7EB; border-radius: 50%; border-top: 3px solid #FF8200; width: 24px; height: 24px; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .auth-input { @apply w-full p-4 bg-gray-50 border border-gray-200 rounded-2xl focus:outline-none focus:ring-2 focus:ring-utep-orange/50 focus:border-utep-orange transition-all mb-3 text-base font-medium; }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: { 
                    colors: { utep: { blue: '#041E42', orange: '#FF8200', gray: '#B1B3B3' } },
                    boxShadow: { 'soft': '0 10px 40px -10px rgba(0,0,0,0.08)' }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 text-gray-800 h-screen w-screen flex flex-col overflow-hidden">

    <!-- Status Bar Spacer (iOS) -->
    <div class="h-safe-top w-full bg-utep-blue"></div>

    <!-- Top Header -->
    <header id="app-header" class="bg-utep-blue text-white z-20 pt-safe transition-all duration-300 hidden">
        <div class="max-w-md mx-auto px-5 pb-4 pt-2 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-gradient-to-br from-utep-orange to-orange-500 rounded-full flex items-center justify-center font-bold text-white shadow-lg text-lg">S</div>
                <div>
                    <h1 class="font-extrabold text-xl tracking-tight leading-none">UTEP SHPE</h1>
                    <p class="text-xs text-blue-200 font-medium tracking-wide opacity-80">STUDENT CHAPTER</p>
                </div>
            </div>
            <div class="relative flex items-center gap-4">
                <div id="auth-status" class="hidden"></div>
                <button onclick="toggleNotifications()" class="w-10 h-10 bg-white/10 rounded-full flex items-center justify-center backdrop-blur-md active-scale relative">
                    <i class="fas fa-bell text-sm"></i>
                    <span id="notif-badge" class="absolute top-2 right-2 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-utep-blue hidden"></span>
                </button>
            </div>
        </div>
        <!-- Notification Dropdown -->
        <div id="notif-dropdown" class="absolute right-4 top-20 w-72 bg-white text-gray-800 rounded-2xl shadow-soft border border-gray-100 hidden transform transition-all duration-200 origin-top-right z-50 overflow-hidden">
            <div class="p-4 border-b border-gray-50 bg-gray-50/50 text-xs font-bold text-gray-400 tracking-wider">NOTIFICATIONS</div>
            <div class="max-h-64 overflow-y-auto" id="notif-list"></div>
        </div>
    </header>

    <!-- Main Content Area -->
    <main id="main-container" class="flex-1 overflow-y-auto hide-scrollbar pb-32 max-w-md mx-auto w-full relative">
        <!-- Initial Loading State -->
        <div class="flex flex-col items-center justify-center h-full space-y-6 px-8 text-center">
            <div class="loader w-10 h-10 border-4"></div>
            <div>
                <h3 class="font-bold text-utep-blue text-lg">Loading Portal</h3>
                <p class="text-sm text-gray-400 mt-1" id="loading-text">Connecting to Miners Network...</p>
            </div>
            <div id="error-box" class="hidden bg-red-50 border border-red-100 text-red-600 p-4 rounded-2xl text-sm text-left w-full shadow-sm"></div>
            <button onclick="app.handleSignOut()" class="text-xs text-gray-400 font-medium mt-8 py-2 px-4 rounded-full border border-gray-200 hover:bg-white transition-colors">Cancel Request</button>
        </div>
    </main>

    <!-- Bottom Navigation -->
    <nav id="app-nav" class="fixed bottom-0 w-full glass z-30 pb-safe hidden">
        <div class="max-w-md mx-auto flex justify-around items-center h-16 px-2">
            <button onclick="app.navigate('home')" class="nav-btn group flex flex-col items-center justify-center w-full h-full text-utep-blue relative" data-target="home">
                <div class="mb-1 p-1.5 rounded-xl group-active:bg-blue-50 transition-colors"><i class="fas fa-home text-xl transition-transform group-active:scale-90"></i></div>
                <span class="text-[10px] font-bold tracking-wide">Home</span>
            </button>
            <button onclick="app.navigate('events')" class="nav-btn group flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-utep-blue transition-colors" data-target="events">
                <div class="mb-1 p-1.5 rounded-xl group-active:bg-blue-50 transition-colors"><i class="fas fa-calendar-day text-xl transition-transform group-active:scale-90"></i></div>
                <span class="text-[10px] font-bold tracking-wide">Events</span>
            </button>
            <div class="w-16"></div> <!-- Spacer for FAB -->
            <button onclick="app.navigate('leaderboard')" class="nav-btn group flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-utep-blue transition-colors" data-target="leaderboard">
                <div class="mb-1 p-1.5 rounded-xl group-active:bg-blue-50 transition-colors"><i class="fas fa-trophy text-xl transition-transform group-active:scale-90"></i></div>
                <span class="text-[10px] font-bold tracking-wide">Rank</span>
            </button>
            <button id="nav-admin-btn" onclick="app.navigate('admin')" class="nav-btn group flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-utep-blue transition-colors hidden" data-target="admin">
                <div class="mb-1 p-1.5 rounded-xl group-active:bg-blue-50 transition-colors"><i class="fas fa-shield-alt text-xl transition-transform group-active:scale-90"></i></div>
                <span class="text-[10px] font-bold tracking-wide">Admin</span>
            </button>
        </div>
    </nav>

    <!-- Floating Action Button (Center) -->
    <div id="scan-fab-container" class="fixed bottom-0 left-0 w-full pb-safe z-40 pointer-events-none hidden">
        <div class="max-w-md mx-auto relative h-16 flex justify-center">
            <button onclick="toggleScanner()" class="pointer-events-auto -mt-6 w-16 h-16 bg-utep-orange text-white rounded-full shadow-lg shadow-orange-500/30 flex items-center justify-center transform transition-transform active:scale-90 hover:scale-105 border-4 border-gray-50">
                <i class="fas fa-qrcode text-2xl"></i>
            </button>
        </div>
    </div>

    <!-- Scanner Modal -->
    <div id="scanner-modal" class="fixed inset-0 bg-utep-blue/90 backdrop-blur-sm z-50 hidden flex flex-col items-center justify-center p-6 animate-fade-in">
        <div class="bg-white w-full max-w-sm rounded-3xl p-8 text-center shadow-2xl relative overflow-hidden">
            <button onclick="toggleScanner()" class="absolute top-4 right-4 w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center text-gray-500 hover:bg-gray-200"><i class="fas fa-times"></i></button>
            
            <div class="w-16 h-16 bg-blue-50 rounded-full flex items-center justify-center mx-auto mb-6 text-utep-blue">
                <i class="fas fa-camera text-3xl"></i>
            </div>
            
            <h2 class="text-2xl font-bold text-utep-blue mb-2">Check-in</h2>
            <p class="text-gray-500 text-sm mb-6">Enter the event code provided by an officer to earn points.</p>
            
            <input type="text" id="event-code-input" placeholder="CODE" class="w-full bg-gray-50 border-2 border-gray-100 rounded-2xl p-4 text-center text-2xl font-bold tracking-[0.2em] uppercase mb-4 focus:outline-none focus:border-utep-orange focus:bg-white transition-all text-utep-blue placeholder-gray-300">
            
            <button onclick="app.submitCode()" class="w-full bg-utep-blue text-white py-4 rounded-2xl font-bold shadow-lg shadow-blue-900/20 active-scale hover:bg-blue-900 transition-all">Verify Code</button>
        </div>
    </div>

    <!-- Firebase & App Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, getDocs, setDoc, updateDoc, onSnapshot, query, where, increment, arrayUnion, addDoc, orderBy, limit, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDtTw7tkJjgh3id4jMVAKwRU1OxXjC66qY",
            authDomain: "shpedemodraftapp.firebaseapp.com",
            projectId: "shpedemodraftapp",
            storageBucket: "shpedemodraftapp.firebasestorage.app",
            messagingSenderId: "935989704959",
            appId: "1:935989704959:web:b2538d47e4a43d463974ca"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- STATE MANAGEMENT ---
        const state = {
            user: null,
            profile: null,
            events: [],
            leaderboard: [],
            resources: [],
            allMembers: [],
            currentView: 'auth',
            isOfficer: false
        };

        const showError = (msg) => {
            const errorBox = document.getElementById('error-box');
            if(errorBox) {
                errorBox.innerHTML = `<div class="flex items-center gap-3"><i class="fas fa-exclamation-circle text-xl"></i><div><strong>Error</strong><div class="text-xs opacity-90">${msg}</div></div></div>`;
                errorBox.classList.remove('hidden');
                setTimeout(() => { if(errorBox) errorBox.classList.add('hidden'); }, 8000);
            }
            console.error(msg);
        };

        // --- CORE APPLICATION ---
        const App = {
            init: async () => {
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        state.user = user;
                        await App.loadUserProfile(user.uid);
                    } else {
                        state.user = null;
                        state.profile = null;
                        state.isOfficer = false;
                        App.navigate('auth');
                        document.getElementById('app-header').classList.add('hidden');
                        document.getElementById('app-nav').classList.add('hidden');
                        document.getElementById('scan-fab-container').classList.add('hidden');
                    }
                });
            },

            loadUserProfile: async (uid) => {
                const userRef = doc(db, 'users', uid);
                onSnapshot(userRef, async (docSnap) => {
                    if (docSnap.exists()) {
                        state.profile = docSnap.data();
                        state.isOfficer = state.profile.role === 'Officer';
                        
                        document.getElementById('app-header').classList.remove('hidden');
                        document.getElementById('app-nav').classList.remove('hidden');
                        
                        if(state.isOfficer) {
                            document.getElementById('nav-admin-btn').classList.remove('hidden');
                            document.getElementById('scan-fab-container').classList.add('hidden'); 
                            App.loadAdminData();
                        } else {
                            document.getElementById('nav-admin-btn').classList.add('hidden');
                            document.getElementById('scan-fab-container').classList.remove('hidden');
                        }

                        if(state.currentView === 'auth') App.navigate('home');
                        App.setupRealtimeListeners();
                        App.seedDatabase(); 
                        App.render();
                    } else {
                        setTimeout(async () => {
                            const doubleCheck = await getDoc(userRef);
                            if(!doubleCheck.exists()) {
                                await setDoc(userRef, {
                                    name: state.user.displayName || "Miner Member",
                                    role: "Member",
                                    points: 0,
                                    status: "Active",
                                    checkedInEvents: [],
                                    email: state.user.email || "",
                                    createdAt: new Date().toISOString()
                                }).catch(err => showError("DB Init Failed: " + err.code));
                            }
                        }, 2000);
                    }
                }, (error) => showError("Sync Error: " + error.message));
            },

            loadAdminData: () => {
                const qUsers = query(collection(db, 'users'));
                onSnapshot(qUsers, (snapshot) => {
                    state.allMembers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if(state.currentView === 'admin') App.render();
                });
            },

            setupRealtimeListeners: () => {
                const qEvents = query(collection(db, 'events'));
                onSnapshot(qEvents, (snapshot) => {
                    state.events = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if(['home', 'events', 'admin'].includes(state.currentView)) App.render();
                });

                const qLeaderboard = query(collection(db, 'users'), orderBy('points', 'desc'), limit(10));
                onSnapshot(qLeaderboard, (snapshot) => {
                    state.leaderboard = snapshot.docs.map(doc => doc.data());
                    if(['home', 'leaderboard'].includes(state.currentView)) App.render();
                });

                const qResources = query(collection(db, 'resources'));
                onSnapshot(qResources, (snapshot) => {
                    state.resources = snapshot.docs.map(doc => doc.data());
                    if(state.currentView === 'resources') App.render();
                });
            },

            navigate: (view) => {
                state.currentView = view;
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.classList.remove('text-utep-blue');
                    btn.classList.add('text-gray-400');
                    const icon = btn.querySelector('i');
                });
                const activeBtn = document.querySelector(`button[data-target="${view}"]`);
                if(activeBtn) {
                    activeBtn.classList.remove('text-gray-400');
                    activeBtn.classList.add('text-utep-blue');
                }
                App.render();
            },

            render: () => {
                const container = document.getElementById('main-container');
                if (!container) return;

                if (state.currentView === 'auth') renderAuth(container);
                else if (state.currentView === 'home') renderHome(container);
                else if (state.currentView === 'events') renderEvents(container);
                else if (state.currentView === 'leaderboard') renderLeaderboard(container);
                else if (state.currentView === 'admin') renderAdmin(container);
                else if (state.currentView === 'resources') renderResources(container);
            },

            // --- ACTIONS ---

            handleLogin: async (email, pass) => {
                const btn = document.getElementById('btn-login');
                const errBox = document.getElementById('login-error');
                if(errBox) errBox.classList.add('hidden');
                
                try {
                    if(btn) { btn.disabled = true; btn.innerHTML = '<div class="loader w-4 h-4 border-2 border-white/50 border-t-white inline-block mr-2"></div> Connecting...'; }
                    await signInWithEmailAndPassword(auth, email, pass);
                } catch (e) {
                    if(errBox) {
                        let msg = "Incorrect email or password.";
                        if(e.code === 'auth/operation-not-allowed') msg = "Login temporarily disabled.";
                        if(e.code === 'auth/user-not-found') msg = "No account found with this email.";
                        errBox.innerHTML = `<i class="fas fa-exclamation-circle mr-1"></i> ${msg}`;
                        errBox.classList.remove('hidden');
                    }
                    if(btn) { btn.disabled = false; btn.innerText = "Login"; }
                }
            },

            handleSignup: async (email, pass, name, officerCode) => {
                try {
                    const res = await createUserWithEmailAndPassword(auth, email, pass);
                    const role = officerCode === "GOOP" ? "Officer" : "Member";
                    
                    await setDoc(doc(db, 'users', res.user.uid), {
                        name: name,
                        role: role,
                        points: 0,
                        status: "Active",
                        checkedInEvents: [],
                        email: email,
                        password: btoa(pass),
                        createdAt: new Date().toISOString()
                    });
                    
                    App.seedDatabase(); 
                } catch (e) {
                    const btn = document.getElementById('btn-signup');
                    const errBox = document.getElementById('signup-error');
                    if(errBox) {
                        let msg = "Could not create account.";
                        if(e.code === 'auth/email-already-in-use') msg = "Email already registered.";
                        if(e.code === 'auth/weak-password') msg = "Password must be 6+ characters.";
                        errBox.innerHTML = `<i class="fas fa-exclamation-circle mr-1"></i> ${msg}`;
                        errBox.classList.remove('hidden');
                    }
                    if(btn) { btn.disabled = false; btn.innerText = "Sign Up"; }
                    throw e;
                }
            },

            handleSignOut: () => {
                state.user = null;
                state.profile = null;
                signOut(auth);
                if(document.getElementById('loading-spinner')) window.location.reload();
            },

            createEvent: async () => {
                const title = document.getElementById('new-event-title').value;
                const date = document.getElementById('new-event-date').value;
                const time = document.getElementById('new-event-time').value;
                const code = document.getElementById('new-event-code').value.toUpperCase();
                const points = parseInt(document.getElementById('new-event-points').value);
                const type = document.getElementById('new-event-type').value;

                if(!title || !date || !code) return alert("Please fill required fields");

                try {
                    await addDoc(collection(db, 'events'), { title, date, time, loc: "TBD", type, points, code });
                    alert("Event Created Successfully!");
                    document.getElementById('new-event-title').value = '';
                    document.getElementById('new-event-code').value = '';
                } catch(e) {
                    alert("Error: " + e.message);
                }
            },

            deleteEvent: async (id) => {
                if(confirm("Delete this event?")) await deleteDoc(doc(db, 'events', id));
            },

            manualAddPoints: async (userId) => {
                const pts = prompt("Points to add:", "10");
                if(pts && !isNaN(pts)) {
                    await updateDoc(doc(db, 'users', userId), { points: increment(parseInt(pts)) });
                }
            },

            submitCode: async () => {
                const codeInput = document.getElementById('event-code-input');
                const code = codeInput.value.toUpperCase().trim();
                if (!code) return;

                const eventQuery = query(collection(db, 'events'), where('code', '==', code));
                const querySnapshot = await getDocs(eventQuery);

                if (querySnapshot.empty) return alert("Invalid Code");

                const eventDoc = querySnapshot.docs[0];
                const eventData = eventDoc.data();

                if (state.profile.checkedInEvents.includes(eventDoc.id)) return alert("Already checked in!");

                const userRef = doc(db, 'users', state.user.uid);
                await updateDoc(userRef, {
                    points: increment(eventData.points),
                    checkedInEvents: arrayUnion(eventDoc.id)
                });

                alert(`Success! +${eventData.points} pts`);
                toggleScanner();
                codeInput.value = '';
                App.navigate('home');
            },
            
            seedDatabase: async () => {
                try {
                    const eventSnap = await getDocs(collection(db, 'events'));
                    if (eventSnap.empty) {
                        const events = [
                            { title: "General Body Meeting #1", date: "2026-02-10", time: "5:30 PM", loc: "UGLC 106", type: "GBM", points: 10, code: "GBM1" },
                            { title: "Resume Workshop", date: "2026-02-20", time: "4:00 PM", loc: "CS Building 202", type: "Professional", points: 15, code: "LM26" },
                            { title: "Lockheed Martin Info Session", date: "2026-02-25", time: "12:00 PM", loc: "Union East", type: "Professional", points: 20, code: "LMINFO" },
                            { title: "SHPE Social: Bowling", date: "2026-03-05", time: "7:00 PM", loc: "Oasis Lanes", type: "Social", points: 5, code: "BOWL" }
                        ];
                        for (const e of events) await addDoc(collection(db, 'events'), e);
                        
                        const resSnap = await getDocs(collection(db, 'resources'));
                        if(resSnap.empty) {
                             await addDoc(collection(db, 'resources'), {
                                category: "Career Prep", items: [{ title: "SHPE Resume Template", type: "pdf", link: "#" }, { title: "Interview Questions", type: "doc", link: "#" }]
                            });
                        }
                    }
                    // SEED USERS if empty
                    const userSnap = await getDocs(collection(db, 'users'));
                    if (userSnap.empty) {
                         const fakeUsers = [
                            { name: "Sofia R.", points: 520, role: "Member", checkedInEvents: [], email: "sofia@miners.utep.edu", password: btoa("password123"), createdAt: new Date().toISOString() },
                            { name: "Juan C.", points: 490, role: "Member", checkedInEvents: [], email: "juan@miners.utep.edu", password: btoa("password123"), createdAt: new Date().toISOString() },
                            { name: "David L.", points: 310, role: "Member", checkedInEvents: [], email: "david@miners.utep.edu", password: btoa("password123"), createdAt: new Date().toISOString() }
                        ];
                        for (const u of fakeUsers) await addDoc(collection(db, 'users'), u);
                    }
                } catch(e) { console.error("Seed error: ", e); }
            }
        };

        // --- RENDERERS ---

        function renderAuth(container) {
            container.innerHTML = `
                <div class="flex flex-col items-center justify-center min-h-screen px-6 w-full max-w-sm mx-auto animate-fade-in pb-10">
                    <div class="mb-10 text-center">
                        <div class="w-24 h-24 bg-gradient-to-tr from-utep-blue to-blue-900 rounded-3xl flex items-center justify-center font-bold text-white text-5xl mx-auto mb-6 shadow-2xl shadow-blue-900/20 transform rotate-3">
                            <span class="transform -rotate-3 text-utep-orange">S</span>
                        </div>
                        <h1 class="text-3xl font-extrabold text-utep-blue tracking-tight">UTEP SHPE</h1>
                        <p class="text-gray-400 font-medium mt-1">Student Portal</p>
                    </div>

                    <div id="login-form" class="w-full bg-white p-8 rounded-[2rem] shadow-soft border border-gray-100">
                        <h2 class="text-xl font-bold mb-6 text-utep-blue">Welcome back</h2>
                        <div id="login-error" class="hidden bg-red-50 text-red-600 p-3 rounded-xl text-xs mb-4 font-semibold border border-red-100"></div>
                        <input id="login-email" type="email" placeholder="Email (miners.utep.edu)" class="auth-input">
                        <input id="login-pass" type="password" placeholder="Password" class="auth-input">
                        <button id="btn-login" onclick="window.tryLogin()" class="w-full bg-utep-blue text-white py-4 rounded-xl font-bold shadow-lg shadow-blue-900/20 active-scale hover:bg-blue-900 transition-all mt-2">Sign In</button>
                        <p class="mt-6 text-center text-sm text-gray-400 font-medium">New member? <button onclick="toggleAuthMode()" class="text-utep-orange font-bold hover:underline">Create Account</button></p>
                    </div>

                    <div id="signup-form" class="w-full bg-white p-8 rounded-[2rem] shadow-soft border border-gray-100 hidden">
                        <h2 class="text-xl font-bold mb-6 text-utep-blue">Join Chapter</h2>
                        <div id="signup-error" class="hidden bg-red-50 text-red-600 p-3 rounded-xl text-xs mb-4 font-semibold border border-red-100"></div>
                        <input id="signup-name" type="text" placeholder="Full Name" class="auth-input">
                        <input id="signup-email" type="email" placeholder="Email" class="auth-input">
                        <input id="signup-pass" type="password" placeholder="Password (6+ chars)" class="auth-input">
                        <input id="signup-code" type="text" placeholder="Officer Code (Optional)" class="auth-input text-xs tracking-[0.1em] uppercase">
                        <button id="btn-signup" onclick="window.trySignup()" class="w-full bg-utep-orange text-white py-4 rounded-xl font-bold shadow-lg shadow-orange-500/20 active-scale hover:bg-orange-600 transition-all mt-2">Sign Up</button>
                        <p class="mt-6 text-center text-sm text-gray-400 font-medium">Have an account? <button onclick="toggleAuthMode()" class="text-utep-blue font-bold hover:underline">Sign In</button></p>
                         <p class="mt-4 text-center text-[10px] text-gray-300 uppercase tracking-widest">Demo Code: GOOP</p>
                    </div>
                </div>
            `;
        }

        function renderAdmin(container) {
            const memberCount = state.allMembers.length;
            const eventCount = state.events.length;
            container.innerHTML = `
                <div class="p-6 pb-20 animate-fade-in space-y-6">
                    <h2 class="text-2xl font-extrabold text-utep-blue">Officer Dashboard</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-white p-5 rounded-3xl shadow-soft border border-gray-100 text-center">
                            <span class="text-3xl font-extrabold text-utep-orange block mb-1">${memberCount}</span>
                            <span class="text-xs font-bold text-gray-400 uppercase tracking-wide">Members</span>
                        </div>
                        <div class="bg-white p-5 rounded-3xl shadow-soft border border-gray-100 text-center">
                            <span class="text-3xl font-extrabold text-utep-blue block mb-1">${eventCount}</span>
                            <span class="text-xs font-bold text-gray-400 uppercase tracking-wide">Events</span>
                        </div>
                    </div>

                    <div class="bg-white rounded-3xl shadow-soft border border-gray-100 p-6">
                         <h3 class="font-bold text-gray-800 mb-4 text-sm uppercase tracking-wide">Create Event</h3>
                         <div class="space-y-4">
                            <input id="new-event-title" type="text" placeholder="Event Title" class="w-full p-3 bg-gray-50 rounded-xl text-sm font-medium focus:bg-white border border-transparent focus:border-utep-orange transition-colors outline-none">
                            <div class="grid grid-cols-2 gap-3">
                                <input id="new-event-date" type="date" class="p-3 bg-gray-50 rounded-xl text-sm font-medium outline-none">
                                <input id="new-event-time" type="time" class="p-3 bg-gray-50 rounded-xl text-sm font-medium outline-none">
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <select id="new-event-type" class="p-3 bg-gray-50 rounded-xl text-sm font-medium outline-none">
                                    <option value="GBM">GBM</option>
                                    <option value="Social">Social</option>
                                    <option value="Professional">Professional</option>
                                    <option value="Volunteering">Volunteering</option>
                                </select>
                                <input id="new-event-points" type="number" placeholder="Pts" value="10" class="p-3 bg-gray-50 rounded-xl text-sm font-medium outline-none">
                            </div>
                            <input id="new-event-code" type="text" placeholder="CODE (e.g. GBM1)" class="w-full p-3 border-2 border-dashed border-gray-200 rounded-xl text-center font-bold uppercase tracking-widest text-sm focus:border-utep-blue outline-none text-utep-blue">
                            <button onclick="app.createEvent()" class="w-full bg-utep-blue text-white py-3 rounded-xl font-bold text-sm active-scale">Create Event</button>
                         </div>
                    </div>

                    <div>
                        <h3 class="font-bold text-gray-800 mb-4 text-sm uppercase tracking-wide px-2">Member List</h3>
                        <div class="bg-white rounded-3xl shadow-soft border border-gray-100 overflow-hidden">
                             ${state.allMembers.length > 0 ? 
                                `<div class="divide-y divide-gray-50 max-h-80 overflow-y-auto">
                                    ${state.allMembers.map(m => `
                                        <div class="p-4 flex justify-between items-center">
                                            <div>
                                                <p class="font-bold text-sm text-gray-800">${m.name}</p>
                                                <p class="text-xs text-gray-400">${m.email || 'No email'}</p>
                                            </div>
                                            <div class="flex items-center gap-3">
                                                <span class="text-xs font-bold text-gray-400">${m.points} pts</span>
                                                <button onclick="app.manualAddPoints('${m.id}')" class="w-8 h-8 bg-blue-50 text-utep-blue rounded-full flex items-center justify-center active-scale"><i class="fas fa-plus text-xs"></i></button>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>` : `<p class="p-6 text-center text-sm text-gray-400">No members yet.</p>`}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderHome(container) {
            const progress = Math.min(((state.profile?.points || 0) / 500) * 100, 100);
            const nextEvent = state.events.filter(e => new Date(e.date) > new Date()).sort((a,b) => new Date(a.date) - new Date(b.date))[0] 
                || { title: "No upcoming events", type: "N/A", points: 0, date: "--", time: "--", loc: "--" };

            container.innerHTML = `
                <div class="p-6 space-y-6 animate-fade-in">
                    <!-- Header -->
                    <div class="flex justify-between items-end px-2">
                        <div>
                            <p class="text-gray-400 text-xs font-bold uppercase tracking-wide mb-1">Hello,</p>
                            <h2 class="text-2xl font-extrabold text-utep-blue tracking-tight">${state.profile?.name.split(' ')[0]}</h2>
                        </div>
                        <button onclick="app.handleSignOut()" class="bg-red-50 text-red-500 px-3 py-1.5 rounded-full text-xs font-bold active-scale">Sign Out</button>
                    </div>

                    <!-- Digital ID Card -->
                    <div class="bg-gradient-to-br from-utep-blue to-blue-900 rounded-[2rem] p-6 text-white shadow-2xl shadow-blue-900/30 relative overflow-hidden h-56 flex flex-col justify-between">
                        <!-- Abstract Shapes -->
                        <div class="absolute top-0 right-0 w-40 h-40 bg-white opacity-5 rounded-full blur-2xl transform translate-x-10 -translate-y-10"></div>
                        <div class="absolute bottom-0 left-0 w-32 h-32 bg-utep-orange opacity-10 rounded-full blur-2xl transform -translate-x-10 translate-y-10"></div>
                        
                        <div class="relative z-10 flex justify-between items-start">
                            <div>
                                <p class="text-blue-200 text-xs font-medium tracking-wide mb-1">MEMBER ID</p>
                                <h3 class="text-lg font-bold tracking-wide">${state.profile?.name}</h3>
                                <span class="inline-block mt-2 px-2 py-0.5 bg-white/10 backdrop-blur-md rounded-md text-[10px] font-bold border border-white/10">${state.profile?.role}</span>
                            </div>
                            <div class="w-10 h-10 bg-white/10 rounded-full flex items-center justify-center backdrop-blur-md border border-white/20">
                                <i class="fas fa-fingerprint text-white/80"></i>
                            </div>
                        </div>
                        
                        <div class="relative z-10">
                            <div class="flex justify-between items-end mb-2">
                                <div>
                                    <span class="text-4xl font-extrabold tracking-tight">${state.profile?.points || 0}</span>
                                    <span class="text-sm text-blue-200 ml-1">pts</span>
                                </div>
                                <div class="text-right">
                                    <p class="text-[10px] text-blue-200 uppercase font-bold tracking-wider mb-0.5">Status</p>
                                    <p class="text-sm font-bold text-utep-orange">${(state.profile?.points || 0) >= 500 ? 'Gold' : 'Active'}</p>
                                </div>
                            </div>
                            <div class="w-full bg-black/20 rounded-full h-1.5 overflow-hidden">
                                <div class="bg-gradient-to-r from-utep-orange to-orange-400 h-full rounded-full transition-all duration-1000 ease-out shadow-[0_0_10px_rgba(255,130,0,0.5)]" style="width: ${progress}%"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Next Event Widget -->
                    <div class="bg-white p-5 rounded-3xl shadow-soft border border-gray-100 flex items-center gap-4 relative overflow-hidden">
                        <div class="w-1.5 h-full absolute left-0 top-0 bg-utep-orange"></div>
                        <div class="bg-orange-50 w-12 h-12 rounded-2xl flex flex-col items-center justify-center flex-shrink-0 text-utep-orange">
                            <span class="text-[10px] font-bold uppercase leading-none mb-0.5">${nextEvent.date !== '--' ? new Date(nextEvent.date).toLocaleString('default', {month:'short'}) : 'NA'}</span>
                            <span class="text-lg font-bold leading-none">${nextEvent.date !== '--' ? new Date(nextEvent.date).getDate() : '--'}</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between items-center mb-1">
                                <p class="text-xs font-bold text-gray-400 uppercase tracking-wide">Next Up</p>
                                <span class="text-[10px] font-bold text-utep-blue bg-blue-50 px-2 py-0.5 rounded-full">+${nextEvent.points} pts</span>
                            </div>
                            <h4 class="font-bold text-gray-800 text-sm truncate">${nextEvent.title}</h4>
                            <p class="text-xs text-gray-500 mt-0.5 truncate"><i class="fas fa-map-marker-alt mr-1 text-gray-300"></i> ${nextEvent.loc}</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderEvents(container) {
            const sortedEvents = [...state.events].sort((a, b) => new Date(a.date) - new Date(b.date));
            let html = `
                <div class="p-6 sticky top-0 bg-gray-50/95 backdrop-blur-sm z-10 pb-4">
                    <h2 class="text-2xl font-extrabold text-utep-blue">Upcoming</h2>
                </div>
                <div class="px-6 pb-32 space-y-4">`;
            
            if(sortedEvents.length === 0) {
                 html += `<div class="text-center py-10 opacity-50"><i class="fas fa-calendar-times text-4xl mb-3 text-gray-300"></i><p class="text-sm font-bold text-gray-400">No events found</p></div>`;
            } else {
                sortedEvents.forEach(evt => {
                    const isPast = new Date(evt.date) < new Date();
                    const isCheckedIn = state.profile?.checkedInEvents?.includes(evt.id);
                    const dateObj = new Date(evt.date);
                    
                    html += `
                        <div class="bg-white rounded-3xl p-5 shadow-soft border border-gray-100 flex gap-4 items-center relative overflow-hidden active-scale transition-transform ${isPast ? 'opacity-60 grayscale' : ''}">
                            ${isCheckedIn ? '<div class="absolute top-0 right-0 bg-green-500 text-white px-3 py-1 rounded-bl-2xl text-[10px] font-bold shadow-sm">DONE</div>' : ''}
                            <div class="flex-shrink-0 w-14 h-14 bg-gray-50 rounded-2xl flex flex-col items-center justify-center text-gray-600 border border-gray-100">
                                <span class="text-[10px] font-bold uppercase tracking-wider">${dateObj.toLocaleString('default', {weekday: 'short'})}</span>
                                <span class="text-xl font-extrabold text-utep-blue leading-none mt-0.5">${dateObj.getDate()}</span>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="text-[10px] font-bold px-2 py-0.5 rounded-md bg-blue-50 text-utep-blue uppercase tracking-wide">${evt.type}</span>
                                    <span class="text-[10px] font-bold text-orange-400">+${evt.points}</span>
                                </div>
                                <h4 class="font-bold text-gray-900 text-sm leading-tight mb-1 truncate">${evt.title}</h4>
                                <p class="text-xs text-gray-500 font-medium truncate">${evt.time} â€¢ ${evt.loc}</p>
                            </div>
                        </div>`;
                });
            }
            container.innerHTML = html + `</div>`;
        }

        function renderLeaderboard(container) {
             const top3 = state.leaderboard.slice(0, 3);
            const rest = state.leaderboard.slice(3);
            let html = `
                 <div class="bg-utep-blue pt-8 pb-12 px-6 rounded-b-[3rem] text-white text-center shadow-xl mb-6 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-full bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-10"></div>
                    <h2 class="text-2xl font-extrabold mb-1 relative z-10">Leaderboard</h2>
                    <p class="text-blue-200 text-xs font-bold tracking-widest uppercase mb-8 relative z-10">Spring 2026</p>
                    
                    <div class="flex justify-center items-end gap-3 relative z-10 mb-[-2rem]">
                        ${top3[1] ? `
                        <div class="flex flex-col items-center w-24">
                            <div class="w-12 h-12 rounded-full border-2 border-blue-300/30 bg-blue-800 flex items-center justify-center text-sm font-bold mb-2 shadow-lg">${top3[1].name.charAt(0)}</div>
                            <div class="bg-blue-800/80 backdrop-blur-sm w-full h-24 rounded-t-2xl flex justify-center pt-3 border-t border-white/10"><span class="font-bold text-2xl text-blue-200">2</span></div>
                            <div class="absolute bottom-6 w-24 text-center"><p class="text-[10px] font-bold truncate px-1">${top3[1].name.split(' ')[0]}</p><p class="text-[10px] text-orange-400 font-bold">${top3[1].points}</p></div>
                        </div>` : ''}
                        
                        ${top3[0] ? `
                        <div class="flex flex-col items-center w-28 z-10">
                            <i class="fas fa-crown text-utep-orange text-2xl mb-1 animate-bounce"></i>
                            <div class="w-16 h-16 rounded-full border-4 border-utep-orange bg-white text-utep-blue flex items-center justify-center text-xl font-bold mb-2 shadow-xl">${top3[0].name.charAt(0)}</div>
                            <div class="bg-gradient-to-b from-utep-orange to-orange-600 w-full h-32 rounded-t-2xl flex justify-center pt-3 shadow-lg"><span class="font-bold text-3xl text-white">1</span></div>
                             <div class="absolute bottom-8 w-28 text-center"><p class="text-xs font-bold truncate px-1 text-white text-shadow">${top3[0].name.split(' ')[0]}</p><p class="text-xs text-blue-900 font-extrabold bg-white/20 inline-block px-2 rounded-full mt-1">${top3[0].points}</p></div>
                        </div>` : ''}

                        ${top3[2] ? `
                        <div class="flex flex-col items-center w-24">
                            <div class="w-12 h-12 rounded-full border-2 border-blue-300/30 bg-blue-900 flex items-center justify-center text-sm font-bold mb-2 shadow-lg">${top3[2].name.charAt(0)}</div>
                            <div class="bg-blue-900/80 backdrop-blur-sm w-full h-20 rounded-t-2xl flex justify-center pt-3 border-t border-white/10"><span class="font-bold text-2xl text-blue-300">3</span></div>
                            <div class="absolute bottom-6 w-24 text-center"><p class="text-[10px] font-bold truncate px-1">${top3[2].name.split(' ')[0]}</p><p class="text-[10px] text-orange-400 font-bold">${top3[2].points}</p></div>
                        </div>` : ''}
                    </div>
                </div>
                
                <div class="px-6 pb-32 pt-10 space-y-3">
            `;
            rest.forEach((user, index) => {
                const isMe = user.name === state.profile?.name;
                html += `
                    <div class="flex items-center justify-between p-4 rounded-2xl ${isMe ? 'bg-orange-50 border border-orange-100 ring-1 ring-orange-200' : 'bg-white border border-gray-50'} shadow-soft">
                        <div class="flex items-center gap-4">
                            <span class="text-gray-300 font-bold text-sm w-4">${index + 4}</span>
                            <div class="w-8 h-8 rounded-full ${isMe ? 'bg-utep-orange text-white' : 'bg-gray-100 text-gray-500'} flex items-center justify-center text-xs font-bold">
                                ${user.name.charAt(0)}
                            </div>
                            <span class="font-bold text-gray-700 text-sm ${isMe ? 'text-utep-blue' : ''}">${user.name}</span>
                        </div>
                        <span class="font-extrabold text-sm ${isMe ? 'text-utep-orange' : 'text-gray-400'}">${user.points} <span class="text-[10px] font-normal">pts</span></span>
                    </div>
                `;
            });
            container.innerHTML = html + `</div>`;
        }
        
        // --- EXPORTS ---
        window.app = App;
        window.toggleScanner = function() { 
            const modal = document.getElementById('scanner-modal');
            modal.classList.toggle('hidden');
        };
        window.toggleNotifications = function() { 
            document.getElementById('notif-dropdown').classList.toggle('hidden'); 
        };
        window.toggleAuthMode = function() { 
            document.getElementById('login-form').classList.toggle('hidden');
            document.getElementById('signup-form').classList.toggle('hidden');
        };
        window.tryLogin = () => App.handleLogin(document.getElementById('login-email').value, document.getElementById('login-pass').value);
        window.trySignup = () => {
            const email = document.getElementById('signup-email').value;
            const pass = document.getElementById('signup-pass').value;
            const name = document.getElementById('signup-name').value;
            const code = document.getElementById('signup-code').value.toUpperCase();

            if(!email || !pass || !name) return alert("Please fill in all fields.");

            const btn = document.getElementById('btn-signup');
            if(btn) { btn.innerHTML = '<div class="loader w-4 h-4 border-2 border-white/50 border-t-white inline-block mr-2"></div> Creating...'; btn.disabled = true; }

            App.handleSignup(email, pass, name, code).catch(err => {
                 if(btn) { btn.innerText = "Sign Up"; btn.disabled = false; }
            });
        };
        
        App.init();

    </script>
</body>
</html>